type GlyphData = boolean[];

const GLYPH_W = 5;
const GLYPH_H = 7;

function g(pattern: string): GlyphData {
  const bits: boolean[] = [];
  for (const ch of pattern) {
    if (ch === '#') bits.push(true);
    else if (ch === '.') bits.push(false);
  }
  return bits;
}

const GLYPHS: Record<string, GlyphData> = {
  A: g(
    '.###.' +
    '#...#' +
    '#...#' +
    '#####' +
    '#...#' +
    '#...#' +
    '#...#',
  ),
  B: g(
    '####.' +
    '#...#' +
    '#...#' +
    '####.' +
    '#...#' +
    '#...#' +
    '####.',
  ),
  C: g(
    '.###.' +
    '#...#' +
    '#....' +
    '#....' +
    '#....' +
    '#...#' +
    '.###.',
  ),
  D: g(
    '####.' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '####.',
  ),
  E: g(
    '#####' +
    '#....' +
    '#....' +
    '###..' +
    '#....' +
    '#....' +
    '#####',
  ),
  F: g(
    '#####' +
    '#....' +
    '#....' +
    '###..' +
    '#....' +
    '#....' +
    '#....',
  ),
  G: g(
    '.###.' +
    '#...#' +
    '#....' +
    '#.###' +
    '#...#' +
    '#...#' +
    '.###.',
  ),
  H: g(
    '#...#' +
    '#...#' +
    '#...#' +
    '#####' +
    '#...#' +
    '#...#' +
    '#...#',
  ),
  I: g(
    '###..' +
    '.#...' +
    '.#...' +
    '.#...' +
    '.#...' +
    '.#...' +
    '###..',
  ),
  J: g(
    '..###' +
    '...#.' +
    '...#.' +
    '...#.' +
    '...#.' +
    '#..#.' +
    '.##..',
  ),
  K: g(
    '#...#' +
    '#..#.' +
    '#.#..' +
    '##...' +
    '#.#..' +
    '#..#.' +
    '#...#',
  ),
  L: g(
    '#....' +
    '#....' +
    '#....' +
    '#....' +
    '#....' +
    '#....' +
    '#####',
  ),
  M: g(
    '#...#' +
    '##.##' +
    '#.#.#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#',
  ),
  N: g(
    '#...#' +
    '##..#' +
    '#.#.#' +
    '#..##' +
    '#...#' +
    '#...#' +
    '#...#',
  ),
  O: g(
    '.###.' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '.###.',
  ),
  P: g(
    '####.' +
    '#...#' +
    '#...#' +
    '####.' +
    '#....' +
    '#....' +
    '#....',
  ),
  Q: g(
    '.###.' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#.#.#' +
    '#..#.' +
    '.##.#',
  ),
  R: g(
    '####.' +
    '#...#' +
    '#...#' +
    '####.' +
    '#.#..' +
    '#..#.' +
    '#...#',
  ),
  S: g(
    '.###.' +
    '#...#' +
    '#....' +
    '.###.' +
    '....#' +
    '#...#' +
    '.###.',
  ),
  T: g(
    '#####' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..',
  ),
  U: g(
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '.###.',
  ),
  V: g(
    '#...#' +
    '#...#' +
    '#...#' +
    '#...#' +
    '.#.#.' +
    '.#.#.' +
    '..#..',
  ),
  W: g(
    '#...#' +
    '#...#' +
    '#...#' +
    '#.#.#' +
    '#.#.#' +
    '##.##' +
    '#...#',
  ),
  X: g(
    '#...#' +
    '#...#' +
    '.#.#.' +
    '..#..' +
    '.#.#.' +
    '#...#' +
    '#...#',
  ),
  Y: g(
    '#...#' +
    '#...#' +
    '.#.#.' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..',
  ),
  Z: g(
    '#####' +
    '....#' +
    '...#.' +
    '..#..' +
    '.#...' +
    '#....' +
    '#####',
  ),
  '0': g(
    '.###.' +
    '#...#' +
    '#..##' +
    '#.#.#' +
    '##..#' +
    '#...#' +
    '.###.',
  ),
  '1': g(
    '..#..' +
    '.##..' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..' +
    '.###.',
  ),
  '2': g(
    '.###.' +
    '#...#' +
    '....#' +
    '..##.' +
    '.#...' +
    '#....' +
    '#####',
  ),
  '3': g(
    '.###.' +
    '#...#' +
    '....#' +
    '..##.' +
    '....#' +
    '#...#' +
    '.###.',
  ),
  '4': g(
    '...#.' +
    '..##.' +
    '.#.#.' +
    '#..#.' +
    '#####' +
    '...#.' +
    '...#.',
  ),
  '5': g(
    '#####' +
    '#....' +
    '####.' +
    '....#' +
    '....#' +
    '#...#' +
    '.###.',
  ),
  '6': g(
    '.###.' +
    '#....' +
    '#....' +
    '####.' +
    '#...#' +
    '#...#' +
    '.###.',
  ),
  '7': g(
    '#####' +
    '....#' +
    '...#.' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..',
  ),
  '8': g(
    '.###.' +
    '#...#' +
    '#...#' +
    '.###.' +
    '#...#' +
    '#...#' +
    '.###.',
  ),
  '9': g(
    '.###.' +
    '#...#' +
    '#...#' +
    '.####' +
    '....#' +
    '....#' +
    '.###.',
  ),
  ' ': g(
    '.....' +
    '.....' +
    '.....' +
    '.....' +
    '.....' +
    '.....' +
    '.....',
  ),
  '.': g(
    '.....' +
    '.....' +
    '.....' +
    '.....' +
    '.....' +
    '.##..' +
    '.##..',
  ),
  ',': g(
    '.....' +
    '.....' +
    '.....' +
    '.....' +
    '.##..' +
    '..#..' +
    '.#...',
  ),
  ':': g(
    '.....' +
    '.##..' +
    '.##..' +
    '.....' +
    '.##..' +
    '.##..' +
    '.....',
  ),
  '/': g(
    '....#' +
    '...#.' +
    '...#.' +
    '..#..' +
    '.#...' +
    '.#...' +
    '#....',
  ),
  '%': g(
    '##..#' +
    '##.#.' +
    '..#..' +
    '..#..' +
    '.#...' +
    '.#.##' +
    '#..##',
  ),
  '#': g(
    '.#.#.' +
    '.#.#.' +
    '#####' +
    '.#.#.' +
    '#####' +
    '.#.#.' +
    '.#.#.',
  ),
  '!': g(
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..' +
    '..#..' +
    '.....' +
    '..#..',
  ),
  '?': g(
    '.###.' +
    '#...#' +
    '....#' +
    '..##.' +
    '..#..' +
    '.....' +
    '..#..',
  ),
  '-': g(
    '.....' +
    '.....' +
    '.....' +
    '#####' +
    '.....' +
    '.....' +
    '.....',
  ),
  '+': g(
    '.....' +
    '..#..' +
    '..#..' +
    '#####' +
    '..#..' +
    '..#..' +
    '.....',
  ),
  '(': g(
    '..#..' +
    '.#...' +
    '#....' +
    '#....' +
    '#....' +
    '.#...' +
    '..#..',
  ),
  ')': g(
    '..#..' +
    '...#.' +
    '....#' +
    '....#' +
    '....#' +
    '...#.' +
    '..#..',
  ),
  '[': g(
    '.###.' +
    '.#...' +
    '.#...' +
    '.#...' +
    '.#...' +
    '.#...' +
    '.###.',
  ),
  ']': g(
    '.###.' +
    '...#.' +
    '...#.' +
    '...#.' +
    '...#.' +
    '...#.' +
    '.###.',
  ),
};

export class PixelFont {
  private glyphs: Map<string, boolean[]>;

  constructor() {
    this.glyphs = new Map();
    for (const [ch, data] of Object.entries(GLYPHS)) {
      this.glyphs.set(ch, data);
    }
  }

  drawText(
    ctx: CanvasRenderingContext2D,
    text: string,
    x: number,
    y: number,
    color: string = '#ffffff',
    scale: number = 1,
  ): void {
    ctx.fillStyle = color;
    const upper = text.toUpperCase();
    let cursorX = x;

    for (const ch of upper) {
      const glyph = this.glyphs.get(ch);
      if (!glyph) {
        cursorX += (GLYPH_W + 1) * scale;
        continue;
      }

      for (let row = 0; row < GLYPH_H; row++) {
        for (let col = 0; col < GLYPH_W; col++) {
          if (glyph[row * GLYPH_W + col]) {
            ctx.fillRect(
              Math.floor(cursorX + col * scale),
              Math.floor(y + row * scale),
              Math.ceil(scale),
              Math.ceil(scale),
            );
          }
        }
      }
      cursorX += (GLYPH_W + 1) * scale;
    }
  }

  measureText(text: string, scale: number = 1): { width: number; height: number } {
    const charCount = text.length;
    return {
      width: charCount * (GLYPH_W + 1) * scale - (charCount > 0 ? scale : 0),
      height: GLYPH_H * scale,
    };
  }
}
